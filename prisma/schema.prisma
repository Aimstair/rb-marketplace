// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  username       String    @unique
  email          String    @unique
  password       String?
  emailVerified  DateTime?
  role           String    @default("user") // "user" | "admin"
  profilePicture String?
  banner         String?
  bio            String?
  socialLinks    Json? // { discord?: string, twitter?: string, ... }
  isVerified     Boolean   @default(false)
  isBanned       Boolean   @default(false)
  isMuted        Boolean   @default(false)
  mutedUntil     DateTime?
  mutedReason    String?
  lastActive     DateTime  @default(now())
  joinDate       DateTime  @default(now())
  robloxProfile  String?
  discordTag     String?

  // Subscription fields
  subscriptionTier   String    @default("FREE") // "FREE" | "PRO" | "ELITE"
  subscriptionStatus String    @default("ACTIVE") // "ACTIVE" | "CANCELLED" | "EXPIRED"
  subscriptionEndsAt DateTime?

  // Relations
  itemListings     ItemListing[]     @relation("ItemListings")
  currencyListings CurrencyListing[] @relation("CurrencyListings")
  listingVotes     ListingVote[]
  vouchesReceived  Vouch[]           @relation("VouchesReceived")
  vouchesSent      Vouch[]           @relation("VouchesSent")
  subscriptionLogs SubscriptionLog[]

  // Messaging relations
  conversationsInitiated Conversation[] @relation("Buyer")
  conversationsReceived  Conversation[] @relation("Seller")
  messagesSent           Message[]      @relation("Sender")

  // Transaction relations
  buyerTransactions  Transaction[] @relation("BuyerTransactions")
  sellerTransactions Transaction[] @relation("SellerTransactions")

  // Notification relations
  notifications Notification[]

  // Follow relations
  followers UserFollow[] @relation("FollowedBy")
  following UserFollow[] @relation("Following")

  // Report relations
  listingReportsSubmitted ReportListing[] @relation("ListingReporterUser")
  userReportsSubmitted    ReportUser[]    @relation("UserReporterUser")
  userReportsReceived     ReportUser[]    @relation("ReportedUser")

  // Admin relations
  auditLogs      AuditLog[]      @relation("AdminUser")
  supportTickets SupportTicket[]

  // Custom role relation
  customRoleId String?
  customRole   Role?   @relation(fields: [customRoleId], references: [id], onDelete: SetNull)

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model UserFollow {
  id String @id @default(cuid())

  followerId String
  follower   User   @relation("FollowedBy", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

// REMOVED: Old Listing model - data migrated to ItemListing/CurrencyListing
// See migrate-listings.js for migration script

// New dedicated Item Listing model
model ItemListing {
  id String @id @default(cuid())

  // Basic Info
  title       String
  description String?
  price       Int
  stock       Int     @default(1)
  image       String

  // Game and Item relations
  gameId     String
  game       Game     @relation("ItemListingGame", fields: [gameId], references: [id], onDelete: Cascade)
  gameItemId String
  gameItem   GameItem @relation("ItemListingGameItem", fields: [gameItemId], references: [id], onDelete: Cascade)

  // Item Details
  listingType String @default("Item") // Always "Item"
  condition   String // "Mint" | "New" | "Used"
  pricingMode String @default("per-item") // "per-peso" | "per-item"

  // Status
  status   String  @default("available") // "available" | "sold"
  featured Boolean @default(false)

  // Engagement metrics
  views     Int @default(0)
  upvotes   Int @default(0)
  downvotes Int @default(0)

  // Relations
  sellerId String
  seller   User   @relation("ItemListings", fields: [sellerId], references: [id], onDelete: Cascade)

  // Note: votes, conversations, transactions, and reports reference this table
  // via listingId + listingType="ITEM" pattern (no back-reference needed)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([status])
  @@index([gameId])
  @@index([gameItemId])
  @@map("item_listings")
}



// New dedicated Currency Listing model
model CurrencyListing {
  id String @id @default(cuid())

  // Basic Info
  title       String
  description String?

  // Game and Currency relations
  gameId         String
  game           Game         @relation("CurrencyListingGame", fields: [gameId], references: [id], onDelete: Cascade)
  gameCurrencyId String
  gameCurrency   GameCurrency @relation("CurrencyListingCurrency", fields: [gameCurrencyId], references: [id], onDelete: Cascade)

  // Currency Details
  listingType String @default("Currency") // Always "Currency"
  ratePerPeso Float // How much currency per PHP 1
  pricingMode String @default("per-peso") // "per-peso" | "per-item"
  stock       Int // Available amount
  minOrder    Int // Minimum order quantity
  maxOrder    Int // Maximum order quantity

  // Display
  image String

  // Status
  status   String  @default("available") // "available" | "sold"
  featured Boolean @default(false)

  // Engagement metrics
  views     Int @default(0)
  upvotes   Int @default(0)
  downvotes Int @default(0)

  // Relations
  sellerId String
  seller   User   @relation("CurrencyListings", fields: [sellerId], references: [id], onDelete: Cascade)

  // Note: votes, conversations, transactions, and reports reference this table
  // via listingId + listingType="CURRENCY" pattern (no back-reference needed)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerId])
  @@index([status])
  @@index([gameId])
  @@index([gameCurrencyId])
  @@map("currency_listings")
}



model ListingVote {
  id String @id @default(cuid())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  listingId   String
  listingType String // "ITEM" | "CURRENCY" | "OLD"

  // Note: listingId references different tables based on listingType
  // OLD -> listings table, ITEM -> item_listings, CURRENCY -> currency_listings
  // No foreign key constraint to allow flexibility

  // Vote type
  type String // "UP" | "DOWN"

  createdAt DateTime @default(now())

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@index([listingType])
  @@map("listing_votes")
}

model ListingView {
  id String @id @default(cuid())

  listingId   String
  listingType String // "ITEM" | "CURRENCY"
  
  // Track by user ID if logged in, otherwise by session/IP identifier
  userId      String? // Null for anonymous users
  sessionId   String? // For anonymous tracking
  ipAddress   String? // Additional anonymous identifier
  
  viewedAt DateTime @default(now())

  @@unique([listingId, userId, sessionId]) // One view per listing per user/session
  @@index([listingId])
  @@index([userId])
  @@index([sessionId])
  @@map("listing_views")
}

model Vouch {
  id String @id @default(cuid())

  // Relations
  fromUserId String
  fromUser   User   @relation("VouchesSent", fields: [fromUserId], references: [id], onDelete: Cascade)

  toUserId String
  toUser   User   @relation("VouchesReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  // Optional transaction reference (for trade verification)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  type    String // "buyer" | "seller"
  message String?
  rating  Int     @default(5) // 1-5 star rating

  // Status tracking
  status          String    @default("VALID") // "VALID" | "INVALID"
  invalidatedBy   String? // Admin user ID
  invalidatedAt   DateTime?
  invalidReason   String?

  createdAt DateTime @default(now())

  @@index([fromUserId, toUserId]) // Changed from unique to index to allow multiple vouches with different statuses
  @@index([toUserId])
  @@index([transactionId])
  @@map("vouches")
}

model Conversation {
  id String @id @default(cuid())

  // Relations to users
  buyerId String
  buyer   User   @relation("Buyer", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)

  // Listing reference with type discriminator
  listingId   String?
  listingType String? // "ITEM" | "CURRENCY" | "OLD"

  // Note: listingId references different tables based on listingType
  // OLD -> listings table, ITEM -> item_listings, CURRENCY -> currency_listings
  // No foreign key constraint to allow flexibility

  // Messages in this conversation
  messages Message[]

  // Transactions linked to this conversation
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@map("conversations")
}

model Message {
  id String @id @default(cuid())

  // Relations
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)

  // Content
  content       String
  attachmentUrl String?

  // Counteroffer
  offerAmount Int?
  amount      Int? // For partial currency sales or bulk orders

  // Status
  isRead          Boolean @default(false)
  isSystemMessage Boolean @default(false)
  offerStatus     String? @default("pending") // "pending" | "accepted" | "declined"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model Transaction {
  id String @id @default(cuid())

  // Relations
  buyerId String
  buyer   User   @relation("BuyerTransactions", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("SellerTransactions", fields: [sellerId], references: [id], onDelete: Cascade)

  listingId   String
  listingType String // "ITEM" | "CURRENCY" | "OLD"

  // Note: listingId references different tables based on listingType
  // OLD -> listings table, ITEM -> item_listings, CURRENCY -> currency_listings  
  // No foreign key constraint to allow flexibility

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  // Transaction details
  price  Int
  amount Int? // Quantity/amount of currency or items for this transaction
  status String @default("PENDING") // "PENDING" | "COMPLETED" | "CANCELLED"

  // Currency-specific fields
  pricePerUnit Float? // Rate at time of purchase (for currency)
  totalPrice   Int? // Total price in PHP (for currency)

  // Confirmation flags
  buyerConfirmed  Boolean @default(false)
  sellerConfirmed Boolean @default(false)

  // Dispute relation
  dispute Dispute?

  // Vouches linked to this transaction
  vouches Vouch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([listingType])
  @@index([conversationId])
  @@map("transactions")
}

model Notification {
  id String @id @default(cuid())

  // Recipient
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  type    String // "MESSAGE" | "ORDER_NEW" | "ORDER_UPDATE" | "SYSTEM"
  title   String
  message String
  link    String?

  // Status
  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model ReportListing {
  id String @id @default(cuid())

  // Reporter
  reporterId String
  reporter   User   @relation("ListingReporterUser", fields: [reporterId], references: [id], onDelete: Cascade)

  // Reported listing with type discriminator
  listingId   String
  listingType String // "ITEM" | "CURRENCY"

  // Note: listingId references different tables based on listingType
  // ITEM -> item_listings, CURRENCY -> currency_listings
  // No foreign key constraint to allow flexibility

  // Report details
  reason  String // "Scam" | "Spam" | "Inappropriate" | "Fake Items" | etc
  details String?
  status  String  @default("PENDING") // "PENDING" | "RESOLVED" | "DISMISSED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reporterId])
  @@index([listingId])
  @@index([listingType])
  @@index([status])
  @@index([createdAt])
  @@map("report_listings")
}

model ReportUser {
  id String @id @default(cuid())

  // Reporter
  reporterId String
  reporter   User   @relation("UserReporterUser", fields: [reporterId], references: [id], onDelete: Cascade)

  // Reported user
  reportedId String
  reported   User   @relation("ReportedUser", fields: [reportedId], references: [id], onDelete: Cascade)

  // Report details
  reason  String // "Scam" | "Spam" | "Inappropriate" | "Impersonation" | etc
  details String?
  status  String  @default("PENDING") // "PENDING" | "RESOLVED" | "DISMISSED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@index([createdAt])
  @@map("report_users")
}

// Game and Currency master data
model Game {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "Blox Fruits", "Pet Simulator X"
  displayName String // Display name with proper formatting
  description String?
  image       String?
  isActive    Boolean @default(true)
  order       Int     @default(0) // For sorting

  // Relations
  currencies       GameCurrency[]      @relation
  items            GameItem[]          @relation
  itemListings     ItemListing[]       @relation("ItemListingGame")
  currencyListings CurrencyListing[]   @relation("CurrencyListingGame")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("games")
}

model GameCurrency {
  id String @id @default(cuid())

  // Relations
  gameId String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // Currency details
  name        String // e.g., "Fragments", "Gems", "Robux"
  displayName String // Display name with proper formatting
  description String?
  icon        String?
  isActive    Boolean @default(true)
  order       Int     @default(0) // For sorting within a game

  // Relations
  currencyListings CurrencyListing[] @relation("CurrencyListingCurrency")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, name])
  @@index([gameId])
  @@index([isActive])
  @@map("game_currencies")
}

model GameItem {
  id String @id @default(cuid())

  // Relations
  gameId String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // Item details
  name        String // e.g., "Huge Pets", "Robux", "Knives", "VIP Pass"
  displayName String // Display name with proper formatting
  description String?
  category    String // "Accessories" | "Games" | "Accounts" | "Currency" | "Items"
  itemType    String // "In-game Items" | "Gamepass" | "Services" | "Accounts" | "Pet" | "Weapon"
  icon        String?
  isActive    Boolean @default(true)
  order       Int     @default(0) // For sorting within a game

  // Relations
  itemListings ItemListing[] @relation("ItemListingGameItem")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, name])
  @@index([gameId])
  @@index([isActive])
  @@index([category])
  @@map("game_items")
}

model SubscriptionLog {
  id String @id @default(cuid())

  // User who purchased/upgraded
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Subscription details
  plan   String // "PRO" | "ELITE"
  amount Int // In cents or pesos

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("subscription_logs")
}

model Dispute {
  id String @id @default(cuid())

  // Relations
  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // Details
  reason     String // "Item Not Received" | "Item Different" | "Scam" | "Other"
  status     String  @default("OPEN") // "OPEN" | "RESOLVED"
  resolution String? // Resolution details

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([status])
  @@index([createdAt])
  @@map("disputes")
}

model SupportTicket {
  id String @id @default(cuid())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Details
  subject String
  message String @db.Text
  status  String @default("OPEN") // "OPEN" | "CLOSED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("support_tickets")
}

model Announcement {
  id String @id @default(cuid())

  // Details
  title     String
  content   String    @db.Text
  type      String    @default("info") // "info" | "warning" | "maintenance" | "event" | "update"
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@map("announcements")
}

model Role {
  id String @id @default(cuid())

  // Role details
  name        String   @unique
  description String?
  color       String // For UI badges (e.g., "bg-red-500", "bg-blue-500")
  permissions String[] // Array of permission IDs (e.g., ["users_view", "users_ban", "listings_edit"])

  // Relations
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([createdAt])
  @@map("roles")
}

model AuditLog {
  id String @id @default(cuid())

  // Relations
  adminId String
  admin   User   @relation("AdminUser", fields: [adminId], references: [id], onDelete: Cascade)

  // Details
  action   String // "USER_BANNED" | "REPORT_RESOLVED" | "TICKET_CLOSED" | "ANNOUNCEMENT_CREATED" | etc
  targetId String? // ID of affected user/listing/report
  details  String? @db.Text

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model FilterOption {
  id        String   @id @default(cuid())
  type      String // "CATEGORY" | "GAME" | "ITEM_TYPE" | "CONDITION"
  label     String
  value     String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@map("filter_options")
}
